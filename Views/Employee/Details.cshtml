@model PayrollIntegrationDashboard.Models.EmployeeDetailsViewModel
@using System.Globalization

@{
    ViewData["Title"] = "Employee details";
    var culture = CultureInfo.GetCultureInfo("nb-NO");

    // Build calendar grid for the selected month
    var monthStart = DateTime.ParseExact(Model.SelectedMonth + "-01", "yyyy-MM-dd", CultureInfo.InvariantCulture);
    var monthEnd = monthStart.AddMonths(1);

    // first day to show (start on Monday)
    int offset = ((int)monthStart.DayOfWeek + 6) % 7; // Monday = 0
    var gridStart = monthStart.AddDays(-offset);

    var totalDays = 42; // 6 weeks
    var hoursLookup = Model.CalendarDays.ToDictionary(d => d.Date.Date, d => d.TotalHours);
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h3 class="mb-0">Employee @Model.Employee.Id</h3>
        <small class="text-muted">
            Contract &amp; activity overview
        </small>
    </div>
    <div>
        <a asp-controller="Integration" asp-action="Index" class="btn btn-outline-secondary btn-sm me-2">
            <i class="bi bi-arrow-left-short me-1"></i> Back to dashboard
        </a>
    </div>
</div>

<div class="row g-4 mb-4">
    <!-- PROFILE / CONTRACT -->
    <div class="col-lg-5">
        <div class="card p-4 mb-3">
            <form asp-action="Update" method="post" novalidate>
                <input type="hidden" asp-for="Employee.Id" />
                <input type="hidden" asp-for="SelectedMonth" />

                <h6 class="mb-3">Employee profile</h6>

                <div asp-validation-summary="ModelOnly" class="text-danger small mb-2"></div>

                <div class="mb-3">
                    <label asp-for="Employee.Name" class="form-label">Name</label>
                    <input asp-for="Employee.Name" class="form-control" placeholder="Optional display name" />
                    <span asp-validation-for="Employee.Name" class="text-danger small"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Employee.Customer" class="form-label">Customer</label>
                    <select asp-for="Employee.Customer" class="form-select">
                        <option value="">– Not set –</option>
                        @foreach (var c in Model.Customers)
                        {
                            <option value="@c">@c</option>
                        }
                    </select>
                    <span asp-validation-for="Employee.Customer" class="text-danger small"></span>
                    <small class="text-muted d-block mt-1">
                        Determines which customer the employee appears under in the dashboard.
                    </small>
                </div>

                <div class="mb-3">
                    <label asp-for="Employee.HourlyRate" class="form-label">Hourly rate</label>
                    <div class="input-group">
                        <span class="input-group-text">kr</span>
                        <input asp-for="Employee.HourlyRate" class="form-control" type="number" step="10" min="0" />
                    </div>
                    <span asp-validation-for="Employee.HourlyRate" class="text-danger small"></span>
                    <small class="text-muted d-block mt-1">
                        Changing this updates gross pay and payout calculations across the dashboard.
                    </small>
                </div>

                <div class="mb-3">
                    <label asp-for="Employee.ContractType" class="form-label">Contract type</label>
                    <select asp-for="Employee.ContractType" class="form-select">
                        <option value="">– Not set –</option>
                        <option>Full-time</option>
                        <option>Part-time</option>
                        <option>Hourly</option>
                        <option>Temporary</option>
                    </select>
                    <span asp-validation-for="Employee.ContractType" class="text-danger small"></span>
                </div>

                <div class="mb-3 row">
                    <div class="col">
                        <label asp-for="Employee.HireDate" class="form-label">Start date</label>
                        <input asp-for="Employee.HireDate" class="form-control" type="date" />
                        <span asp-validation-for="Employee.HireDate" class="text-danger small"></span>
                    </div>
                    <div class="col">
                        <label asp-for="Employee.EndDate" class="form-label">End date</label>
                        <input asp-for="Employee.EndDate" class="form-control" type="date" />
                        <span asp-validation-for="Employee.EndDate" class="text-danger small"></span>
                    </div>
                </div>

                <div class="border-top pt-3 mt-2 d-flex justify-content-between align-items-center">
                    <div class="small text-muted">
                        Saved changes are reflected in summaries, export preview and earnings cards.
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-1"></i> Save changes
                    </button>
                </div>
            </form>
        </div>

        <div class="card p-4">
            <h6 class="mb-2">This month’s cost (preview)</h6>
            <p class="mb-1 small text-muted">
                Based on hours imported for
                <strong>@monthStart.ToString("MMMM yyyy", culture)</strong>.
            </p>
            <div class="d-flex justify-content-between align-items-center mt-2">
                <div>
                    <div class="text-muted small">Total hours</div>
                    <div class="fw-semibold">@Model.MonthTotalHours.ToString("0.##") h</div>
                </div>
                <div class="text-end">
                    <div class="text-muted small">Estimated gross pay</div>
                    <div class="fw-semibold">
                        @Model.MonthGrossPay.ToString("C0", culture)
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CALENDAR -->
    <div class="col-lg-7">
        <div class="card p-4 h-100">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h6 class="mb-1">Time activity calendar</h6>
                    <small class="text-muted">
                        Daily hours for @monthStart.ToString("MMMM yyyy", culture)
                    </small>
                </div>
                <form asp-action="Details" method="get" class="d-flex align-items-center gap-2">
                    <input type="hidden" name="id" value="@Model.Employee.Id" />
                    <select name="month" class="form-select form-select-sm" style="width: 150px;"
                            onchange="this.form.submit()">
                        @for (int i = -2; i <= 2; i++)
                        {
                            var m = monthStart.AddMonths(i);
                            var value = m.ToString("yyyy-MM");
                            <option value="@value" selected="@(value == Model.SelectedMonth)">
                                @m.ToString("MMMM yyyy", culture)
                            </option>
                        }
                    </select>
                </form>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered mb-0 small align-middle">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center">Mon</th>
                            <th class="text-center">Tue</th>
                            <th class="text-center">Wed</th>
                            <th class="text-center">Thu</th>
                            <th class="text-center">Fri</th>
                            <th class="text-center">Sat</th>
                            <th class="text-center">Sun</th>
                        </tr>
                    </thead>
                    <tbody>
                    @{
                        var day = gridStart;
                        for (int row = 0; row < 6; row++)
                        {
                            <tr>
                                @for (int col = 0; col < 7; col++)
                                {
                                    var isCurrentMonth = day >= monthStart && day < monthEnd;
                                    hoursLookup.TryGetValue(day.Date, out var h);

                                    <td class="p-2 @(isCurrentMonth ? "" : "bg-light")">
                                        <div class="d-flex justify-content-between">
                                            <span class="fw-semibold @(isCurrentMonth ? "" : "text-muted")">
                                                @day.Day
                                            </span>
                                            @if (h > 0)
                                            {
                                                <span class="badge bg-primary-subtle text-primary">
                                                    @h.ToString("0.#") h
                                                </span>
                                            }
                                        </div>
                                    </td>

                                    day = day.AddDays(1);
                                }
                            </tr>
                        }
                    }
                    </tbody>
                </table>
            </div>

            <div class="mt-3 small text-muted">
                Calendar is based on <strong>imported time entries</strong> for this employee.
                Adjusting hours is done via imports or manual time entry; this view focuses on
                contract and overview for HR.
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{ await Html.RenderPartialAsync("_ValidationScriptsPartial"); }
}
