@model PayrollIntegrationDashboard.Models.DashboardViewModel
@using System.Text.Json
@using System.Globalization

@{
    ViewData["Title"] = "Dashboard";

    var labelsJson = JsonSerializer.Serialize(Model.HoursLabels);
    var valuesJson = JsonSerializer.Serialize(Model.HoursValues);
    var culture = CultureInfo.GetCultureInfo("nb-NO");
}

<style>
    .metrics-card {
        width: 360px;
        max-width: 90vw;
        background: #ffffff;
        border-radius: 18px;
        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.35);
        padding: 18px 20px 16px;
        animation: slideUpRight 0.22s ease-out;
        font-size: 0.9rem;
        position: fixed;
        z-index: 1200;
    }

    @@keyframes slideUpRight {
        from {
            opacity: 0;
            transform: translate(24px, 24px) scale(0.96);
        }
        to {
            opacity: 1;
            transform: translate(0, 0) scale(1);
        }
    }

    .metrics-close-btn {
        border: none;
        background: transparent;
        font-size: 1.2rem;
        line-height: 1;
        cursor: pointer;
    }

    .metrics-header-title {
        font-weight: 600;
        font-size: 0.95rem;
    }

    .metrics-subtle {
        color: #6b7280;
        font-size: 0.8rem;
    }

    .metrics-summary-row {
        display: flex;
        justify-content: space-between;
        margin-top: 6px;
        margin-bottom: 2px;
        font-size: 0.82rem;
    }

    .metrics-summary-row span:first-child {
        color: #6b7280;
    }

    .employee-row {
        cursor: pointer;
        transition: background-color 0.12s ease;
    }

    .employee-row:hover {
        background-color: #f9fafb;
    }

    .health-chip {
        font-size: 0.8rem;
        padding: 4px 10px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .health-chip-healthy {
        background: rgba(16, 185, 129, 0.12);
        color: #047857;
    }

    .health-chip-degraded {
        background: rgba(245, 158, 11, 0.12);
        color: #92400e;
    }

    .health-chip-attention {
        background: rgba(248, 113, 113, 0.12);
        color: #b91c1c;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h3 class="mb-0">Dashboard</h3>
        <small class="text-muted">Monitor automated integrations between time tracking and payroll</small>
    </div>
    <div>
        <form asp-action="Import" method="post" class="d-inline">
            <button class="btn btn-outline-primary me-2">
                <i class="bi bi-cloud-download me-1"></i> Import time data
            </button>
        </form>
        <form asp-action="Export" method="post" class="d-inline">
            <button class="btn btn-success">
                <i class="bi bi-cloud-upload me-1"></i> Export to payroll
            </button>
        </form>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card card-kpi p-3">
            <div class="small text-muted">Total employees</div>
            <div class="fs-4 fw-semibold">@Model.TotalEmployees</div>
            <div class="small text-success">Synced from HR/time systems</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card card-kpi p-3">
            <div class="small text-muted">Total hours (period)</div>
            <div class="fs-4 fw-semibold">@Model.TotalHours</div>
            <div class="small text-muted">Based on latest import</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card card-kpi p-3">
            <div class="small text-muted">Failed exports queued</div>
            <div class="fs-4 fw-semibold">@Model.FailedExportsQueued</div>
            <form asp-action="Retry" method="post" class="mt-2">
                <button class="btn btn-sm btn-outline-danger">
                    <i class="bi bi-arrow-repeat me-1"></i>Retry queue
                </button>
            </form>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card card-kpi p-3">
            <div class="small text-muted">Estimated payout (period)</div>
            <div class="fs-4 fw-semibold">
                @Model.TotalPayout.ToString("C0", culture)
            </div>
            <div class="small text-muted">Basert på timesatser per ansatt</div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-lg-8">
        <div class="card p-3">
            <h6 class="mb-1">Payroll history (last 7 days)</h6>
            <small class="text-muted">Total imported hours per day</small>

            <div class="chart-wrapper mt-3">
                <canvas id="hoursChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card p-3 h-100">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                    <h6 class="mb-1">Integration health</h6>
                    <small class="text-muted">Status based on imports, exports and failures</small>
                </div>
            </div>

            @{
                var statusClass = Model.HealthStatus switch
                {
                    "Healthy" => "health-chip health-chip-healthy",
                    "Degraded" => "health-chip health-chip-degraded",
                    "Attention needed" => "health-chip health-chip-attention",
                    _ => "health-chip"
                };
            }

            <div class="mt-2">
                <span class="@statusClass">
                    <i class="bi bi-activity"></i>@Model.HealthStatus
                </span>
            </div>

            <div class="small mt-2">@Model.HealthDescription</div>

            <dl class="row small mt-3 mb-0">
                <dt class="col-5 text-muted">Last import</dt>
                <dd class="col-7">
                    @(Model.LastImport?.ToLocalTime().ToString("dd.MM HH:mm") ?? "–")
                </dd>
                <dt class="col-5 text-muted">Last export</dt>
                <dd class="col-7">
                    @(Model.LastExport?.ToLocalTime().ToString("dd.MM HH:mm") ?? "–")
                </dd>
                <dt class="col-5 text-muted">Failed (24h)</dt>
                <dd class="col-7">@Model.FailedExportsLast24h</dd>
            </dl>
        </div>
    </div>
</div>

<div class="card p-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
            <h6 class="mb-0">Recent employees</h6>
            <small class="text-muted">Aggregated hours ready for export</small>
        </div>
        <div class="d-flex align-items-center gap-2">
            <input id="employeeSearch" class="form-control form-control-sm" style="width: 190px;" placeholder="Search employee or period" />
            <select id="employeeFilter" class="form-select form-select-sm" style="width: 160px;">
                <option value="all">All employees</option>
                <option value="highHours">High hours</option>
                <option value="lowHours">Low hours</option>
            </select>
            <a asp-action="Create" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-plus-circle me-1"></i>Manual entry
            </a>
        </div>
    </div>

    <table class="table table-hover align-middle mb-0" id="employeeTable">
        <thead>
            <tr>
                <th>Employee ID</th>
                <th>Total hours</th>
                <th>Hourly rate</th>
                <th>Total pay</th>
                <th>Period</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var s in Model.Summaries)
        {
            <tr class="employee-row"
                data-employee-id="@s.EmployeeId"
                data-total-hours="@s.TotalHours"
                data-period="@s.Period">
                <td>@s.EmployeeId</td>
                <td>@s.TotalHours</td>
                <td>@s.HourlyRate.ToString("C0", culture)</td>
                <td>@s.TotalPay.ToString("C0", culture)</td>
                <td>@s.Period</td>
            </tr>
        }
        </tbody>
    </table>
</div>

<template id="employeeMetricsTemplate">
    <div class="metrics-card" data-role="metrics-card">
        <div class="d-flex justify-content-between align-items-start mb-2" data-role="drag-handle">
            <div>
                <div class="metrics-header-title">
                    Employee <span data-field="employeeId"></span>
                </div>
                <div class="metrics-subtle" data-field="period"></div>
            </div>
            <button type="button" class="metrics-close-btn" data-role="close-btn" aria-label="Close">
                &times;
            </button>
        </div>

        <div class="metrics-summary-row">
            <span>Total hours</span>
            <span data-field="totalHours"></span>
        </div>
        <div class="metrics-summary-row">
            <span>Hourly rate</span>
            <span data-field="hourlyRate"></span>
        </div>
        <div class="metrics-summary-row">
            <span>Gross pay</span>
            <span data-field="grossPay"></span>
        </div>

        <div class="metrics-summary-row mt-2">
            <span>Avg hours/day</span>
            <span data-field="avgPerDay"></span>
        </div>
        <div class="metrics-summary-row">
            <span>Trend</span>
            <span data-field="trend"></span>
        </div>

        <div class="chart-wrapper mt-2" style="height:210px;">
            <canvas data-role="pie"></canvas>
        </div>

        <div class="mt-3 small">
            <p class="mb-1">
                <strong>Take-home:</strong>
                <span data-field="netPay"></span>
            </p>
            <p class="mb-1 metrics-subtle">
                Tax: <span data-field="taxAmount"></span>
                (<span data-field="taxRatePercent"></span> %)
            </p>
            <p class="mb-0 metrics-subtle">
                Company cut: <span data-field="commissionAmount"></span>
                (<span data-field="commissionRatePercent"></span> %)
            </p>
        </div>

        <hr class="my-3">

        <div class="small mb-2 fw-semibold">Scenario: adjust assumptions</div>
        <div class="mb-2">
            <label class="form-label metrics-subtle mb-1">Tax rate</label>
            <input type="range" min="20" max="45" value="32" data-role="taxSlider" class="form-range">
            <div class="d-flex justify-content-between metrics-subtle">
                <span data-role="taxSliderLabel">32 %</span>
                <span>Impact: adjusts tax vs take-home</span>
            </div>
        </div>
        <div class="mb-1">
            <label class="form-label metrics-subtle mb-1">Company cut</label>
            <input type="range" min="0" max="15" value="5" data-role="commissionSlider" class="form-range">
            <div class="d-flex justify-content-between metrics-subtle">
                <span data-role="commissionSliderLabel">5 %</span>
                <span>Higher cut lowers take-home</span>
            </div>
        </div>
    </div>
</template>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // --- main bar chart ---
        const labels = @Html.Raw(labelsJson);
        const values = @Html.Raw(valuesJson);

        const ctx = document.getElementById('hoursChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ label: 'Imported hours', data: values }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } }
            }
        });

        function formatCurrency(value) {
            return new Intl.NumberFormat('nb-NO', {
                style: 'currency',
                currency: 'NOK',
                maximumFractionDigits: 0
            }).format(value);
        }

        const cardTemplate = document.getElementById('employeeMetricsTemplate');

        async function openMetricsCard(employeeId) {
            try {
                const res = await fetch(`/Integration/EmployeeMetrics?id=${employeeId}`);
                if (!res.ok) {
                    console.error('EmployeeMetrics request failed', res.status);
                    return;
                }
                const data = await res.json();

                // build card from template
                const fragment = cardTemplate.content.cloneNode(true);
                const card = fragment.querySelector('[data-role="metrics-card"]');

                if (!card) {
                    console.error('Metrics card template not found');
                    return;
                }

                // cascade cards
                const existing = document.querySelectorAll('.metrics-card').length;
                const offset = existing * 24;
                card.style.right = (24 + offset) + 'px';
                card.style.bottom = (24 + offset) + 'px';

                const setField = (name, value) =>
                    card.querySelector(`[data-field="${name}"]`).textContent = value;

                setField("employeeId", data.employeeId);
                setField("period", `Period ${data.period}`);
                setField("totalHours", data.totalHours);
                setField("hourlyRate", formatCurrency(data.hourlyRate));
                setField("grossPay", formatCurrency(data.grossPay));
                setField("netPay", formatCurrency(data.netPay));
                setField("taxAmount", formatCurrency(data.taxAmount));
                setField("commissionAmount", formatCurrency(data.commissionAmount));
                setField("taxRatePercent", data.taxRatePercent);
                setField("commissionRatePercent", data.commissionRatePercent);
                setField("avgPerDay", data.averageHoursPerDay.toFixed(1));
                setField("trend", data.trendLabel);

                // append card to DOM immediately
                document.body.appendChild(card);

                // close button
                card.querySelector('[data-role="close-btn"]').addEventListener('click', () => {
                    if (card._chartInstance) {
                        card._chartInstance.destroy();
                    }
                    card.remove();
                });

                // drag logic
                const dragHandle = card.querySelector('[data-role="drag-handle"]');
                if (dragHandle) {
                    let isDragging = false;
                    let startX = 0, startY = 0;
                    let startLeft = 0, startTop = 0;

                    dragHandle.style.cursor = 'move';

                    dragHandle.addEventListener('mousedown', (e) => {
                        isDragging = true;
                        const rect = card.getBoundingClientRect();
                        card.style.left = rect.left + 'px';
                        card.style.top = rect.top + 'px';
                        card.style.right = 'auto';
                        card.style.bottom = 'auto';

                        startX = e.clientX;
                        startY = e.clientY;
                        startLeft = rect.left;
                        startTop = rect.top;
                        e.preventDefault();
                    });

                    window.addEventListener('mousemove', (e) => {
                        if (!isDragging) return;
                        const dx = e.clientX - startX;
                        const dy = e.clientY - startY;
                        card.style.left = (startLeft + dx) + 'px';
                        card.style.top = (startTop + dy) + 'px';
                    });

                    window.addEventListener('mouseup', () => {
                        isDragging = false;
                    });
                }

                // chart + sliders (wrapped so errors don't kill the card)
                try {
                    const ctxPie = card.querySelector('[data-role="pie"]').getContext('2d');
                    const baseGross = data.grossPay;
                    const pieChart = new Chart(ctxPie, {
                        type: 'doughnut',
                        data: {
                            labels: ['Take home', 'Tax', 'Company cut'],
                            datasets: [{
                                data: [data.netPay, data.taxAmount, data.commissionAmount],
                                backgroundColor: ['#2563eb', '#f97373', '#fb923c'],
                                borderWidth: 0,
                                hoverOffset: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '55%',
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        boxWidth: 14,
                                        boxHeight: 14,
                                        usePointStyle: true
                                    }
                                }
                            }
                        }
                    });

                    card._chartInstance = pieChart;

                    const taxSlider = card.querySelector('[data-role="taxSlider"]');
                    const commissionSlider = card.querySelector('[data-role="commissionSlider"]');
                    const taxSliderLabel = card.querySelector('[data-role="taxSliderLabel"]');
                    const commissionSliderLabel = card.querySelector('[data-role="commissionSliderLabel"]');

                    taxSlider.value = data.taxRatePercent;
                    commissionSlider.value = data.commissionRatePercent;
                    taxSliderLabel.textContent = `${data.taxRatePercent} %`;
                    commissionSliderLabel.textContent = `${data.commissionRatePercent} %`;

                    function applyScenario() {
                        const taxRate = Number(taxSlider.value) / 100;
                        const commissionRate = Number(commissionSlider.value) / 100;

                        const tax = baseGross * taxRate;
                        const commission = baseGross * commissionRate;
                        const net = baseGross - tax - commission;

                        setField("netPay", formatCurrency(net));
                        setField("taxAmount", formatCurrency(tax));
                        setField("commissionAmount", formatCurrency(commission));
                        setField("taxRatePercent", (taxRate * 100).toFixed(0));
                        setField("commissionRatePercent", (commissionRate * 100).toFixed(0));

                        pieChart.data.datasets[0].data = [net, tax, commission];
                        pieChart.update();
                    }

                    taxSlider.addEventListener('input', () => {
                        taxSliderLabel.textContent = `${taxSlider.value} %`;
                        applyScenario();
                    });
                    commissionSlider.addEventListener('input', () => {
                        commissionSliderLabel.textContent = `${commissionSlider.value} %`;
                        applyScenario();
                    });
                } catch (chartErr) {
                    console.error('Error creating metrics chart', chartErr);
                }
            } catch (e) {
                console.error('openMetricsCard failed', e);
            }
        }

        // row click
        document.querySelectorAll('tr.employee-row').forEach(row => {
            row.addEventListener('click', () => {
                const id = row.getAttribute('data-employee-id');
                openMetricsCard(id);
            });
        });

        // search & filter
        const searchInput = document.getElementById('employeeSearch');
        const filterSelect = document.getElementById('employeeFilter');

        function filterTable() {
            const term = searchInput.value.toLowerCase();
            const filter = filterSelect.value;

            document.querySelectorAll('#employeeTable tbody tr').forEach(row => {
                const employeeId = row.cells[0].innerText.toLowerCase();
                const period = row.getAttribute('data-period').toLowerCase();
                const hours = Number(row.getAttribute('data-total-hours'));

                let visible = true;

                if (term && !(employeeId.includes(term) || period.includes(term))) {
                    visible = false;
                }

                if (filter === 'highHours' && hours < 180) visible = false;
                if (filter === 'lowHours' && hours > 120) visible = false;

                row.style.display = visible ? '' : 'none';
            });
        }

        searchInput.addEventListener('input', filterTable);
        filterSelect.addEventListener('change', filterTable);
    </script>
}
